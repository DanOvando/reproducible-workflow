---
title: "Reproducibility 101"
subtitle: "Survey-centric R users group"
author: "Dan Ovando"
institute: "University of Washington"
date: "2020/10/8"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)

knitr::opts_chunk$set(echo = TRUE, message = TRUE, warning = TRUE)
library(here)
library(xaringan)
library(TMB)
library(tufte)
library(rstan)
library(janitor)
library(dplyr)
library(ggplot2)

hake <- janitor::clean_names(read.table(here::here("data","schaefer.dat"), header=TRUE))

write.csv(hake,here("data","hake.csv"))

```


# We Have a Problem

.center[
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/zwRdO9_GGhY?start=694" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
]

---

# We Have a Problem

.center[
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/zwRdO9_GGhY?start=694" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
]

---


# Today's Content

.pull-left[

- Project Oriented Workflows

- Resilient paths

- Style guides

- Package dependencies

- Scientific collaboration with git + github


].pull-right[

https://www.google.com/url?sa=i&url=https%3A%2F%2Fwww.redbubble.com%2Fi%2Fart-print%2FFitter-Happier-and-More-Productive-by-Usul%2F24874247.1G4ZT&psig=AOvVaw0cY1wMloWpB-UoeizJ8AiV&ust=1602180536175000&source=images&cd=vfe&ved=0CAIQjRxqFwoTCOjX0-OJo-wCFQAAAAAdAAAAABAD



]

---



class: center, inverse, middle
# Science is all about reproducibility! 
# Why should it stop at our code?

???
Most of us trained in things like field methods: I've had way more classes in transect methods than coding practices.

Leads to methods that describe the brand of PVC pipe used but depend on a pile of code that will only work on the users computer for the week they submitted the paper, and never again

we put all this work into getting the data, and then drop the ball at the step that turns all that hard work into insight. 

As code becomes our primary tool, need to apply the same reprodicibility rigorous to our code that we're used to applying in our field methods
---


# Project-Oriented Workflows

>This convention guarantees that the project can be moved around on your computer or onto other computers and will still “just work” `r tufte::quote_footer('--- Jenny Bryan')`

- All files needed to run your analysis in one folder
  - Nested subfolders as needed
  - **Does not have to be RStudio**

- All analysis written assuming
  - Fresh state
  - Working directory set to project directory



---

# Project-Oriented Workflows
see [Good Enough Practices in Scientific Computing](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005510)
![https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005510](https://github.com/super-advanced-r-fall-2019/intro/raw/master/imgs/good-enough.png)

& 
 
---


# Purge `setwd` from your scripts

> *If the first line of your R script is*
  
>  setwd("C:\Users\jenny\path\that\only\I\have")
  
>  *I will come into your office and SET YOUR COMPUTER ON FIRE* 🔥.
  
 > *If the first line of your R script is*
  
>  rm(list = ls())
  
>  *I will come into your office and SET YOUR COMPUTER ON FIRE* 🔥.
`r tufte::quote_footer('--- Jenny Bryan')`
 

---


# What's wrong with `setwd`?

.pull-left[
### Workflow

*Personal decisions*

* Choice of IDE (RStudio, Sublime Text, scanning handwritten notes)

* CaMel or snake_case
  - But seriously, snake_case
  - See [tidyverse style guide](https://style.tidyverse.org/)

* Your lucky coding socks

* **Where the code lives**
]
.pull-right[

### Product

*What the analysis needs*

* The data

* Packages

* Package versions

* Custom functions

* Scripts  to tie it all together

]

---

## Alternatives to `setwd`

Using RStudio is a simple way around this
  
  - Create .Rproj file in the root directory of your project
  
Alternatively...
 
  - Often just open a file in the project directory with R GUI/Atom/Whatever
  

  - If that fails, use `cd` / `setwd` from the command line/console (not in your script) when you open your analysis
  
  - `here` will often do the job for you
  

Using project-oriented workflow means that once you're in the working directory, everything else should work


**It's the user's, not the code's, responsibility to make sure the working directory is set correctly** $^1$

.footnote[
[1] But do what works best for your workflow
]

---

# Exorcise the paths

OK, you've created a project oriented workflow

Is this OK now?

`my_data <- read.csv("data\hake.csv")`

--
- Platform dependent

- Presents some problems for R Markdown

```{r}
getwd()
```

---


# File Paths with `here`

[`here`](https://github.com/jennybc/here_here) is a great little package for managing file paths
  - Basically file.path with a bit of sugar
  
  
```{r}
here::dr_here()
```


`here` has a bunch of heuristics to figure out what the root of the project should be, and builds intelligent paths based on that

```{r}
here::here("data","hake.csv")
```

Looks for...
  - An RStudio project
  - a .git file
  - a .here file
  - etc.

---

# File Paths with `here`
Works on some machines...
```{r, error=TRUE}

hake <- read.csv("data\hake.csv")

```

Works in the markdown but won't work in the command line
```{r}
hake <- read.csv("../data/hake.csv")
```

Works on any platform and from anywhere in the project!
```{r}
hake <- read.csv(here("data","hake.csv"))
```

---

# Package dependencies with renv

OK, you now have a project oriented workflow, and you fixed your paths, what else?

We've all been here...
```{r, error = TRUE}

hake <- as.data.table(hake)

```

Packages are a huge part of reproducibility - even the most "base or bust!" code usually has some package dependencies

- Minimum solution: include ***all*** needed libraries at the start of your main script

```{r, eval = FALSE}

# my amazing wrapper scripts ----------------

# load libraries
library(here)
library(data.table)

```

---

# Package dependencies with `renv`

What does this leave out?

```{r, eval = FALSE}

# my amazing wrapper scripts ----------------

# load libraries
library(here)
library(data.table)

```

--

Particularly for our kind of science-heavy packages we often depend on a *specific version* of a packages
  - Hopefully just a minimum package version 
  - But sometimes...
      - we need an older version
      - we need a specific development version 😟
      
  
Enter `renv`!


---

# Package dependencies with `renv`

[`renv`](https://rstudio.github.io/renv/articles/renv.html) is a relatively new package manager solution from the folks at RStudio
  - See Grant McDermott's [excellent talk](https://www.periscope.tv/grant_mcdermott/1lPJqLjlVAAGb)


---


# Collaboration through Git

---

# Parameterized Markdown Reports


---

# Docker


---


# Style Guides


---



